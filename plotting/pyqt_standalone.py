#!/usr/bin/env python3
"""
Standalone PyQt Grafik Penceresi - Tkinter'dan ayrÄ± process'te Ã§alÄ±ÅŸÄ±r
"""

import sys
import json
import time
import os
from datetime import datetime
from typing import Dict, List

try:
    import pyqtgraph as pg
    from PyQt5.QtWidgets import QApplication, QVBoxLayout, QHBoxLayout, QWidget, QLabel
    from PyQt5.QtCore import QTimer
    from PyQt5.QtGui import QPainter, QColor, QPen, QBrush
    PYQT_AVAILABLE = True
except ImportError:
    print("PyQt5 veya PyQtGraph yÃ¼klÃ¼ deÄŸil!")
    sys.exit(1)

class StandalonePlotWindow:
    """Standalone PyQt grafik penceresi"""
    
    def __init__(self, data_file_path: str):
        self.data_file_path = data_file_path
        self.main_widget = None
        self.plot_widget = None
        self.plot_curves = {}
        self.update_timer = None

        # BaÅŸlangÄ±Ã§ verilerini yÃ¼kle
        self.load_initial_data()

        # Grafik penceresi oluÅŸtur
        self.setup_plot_window()

        # GÃ¼ncelleme timer'Ä± baÅŸlat
        self.setup_update_timer()
    
    def load_initial_data(self):
        """BaÅŸlangÄ±Ã§ verilerini yÃ¼kle"""
        try:
            with open(self.data_file_path, 'r') as f:
                data = json.load(f)
            
            self.window_id = data.get('window_id', 'unknown')
            self.selected_sensors = data.get('selected_sensors', [])
            self.title = data.get('title', 'PyQt Graph')
            self.graph_type = data.get('graph_type', 'line')
            
            print(f"BaÅŸlangÄ±Ã§ verileri yÃ¼klendi: {self.title}")
            
        except Exception as e:
            print(f"Veri yÃ¼kleme hatasÄ±: {e}")
            self.selected_sensors = []
            self.title = "PyQt Graph"
    
    def setup_plot_window(self):
        """Grafik penceresini kur"""
        try:
            # Ana widget oluÅŸtur
            self.main_widget = QWidget()
            layout = QVBoxLayout(self.main_widget)

            # Ãœst baÅŸlÄ±k ekle
            self.create_main_title(layout)

            # LED Renk GÃ¶stergesi
            self.create_led_legend(layout)

            # Plot widget oluÅŸtur
            self.plot_widget = pg.PlotWidget()

            # Grafik ayarlarÄ± - Y ekseni formatÄ±nÄ± belirle
            if "Calibrated" in self.title:
                self.plot_widget.setLabel('left', 'Calibrated Value (N/A if no calibration)')
            else:
                self.plot_widget.setLabel('left', 'Voltage (mV)')
            
            self.plot_widget.setLabel('bottom', 'Time (seconds)')
            # Title'Ä± kaldÄ±rdÄ±k, Ã¼stte bÃ¼yÃ¼k baÅŸlÄ±k var
            self.plot_widget.showGrid(x=True, y=True, alpha=0.3)
            self.plot_widget.enableAutoRange()
            self.plot_widget.setMouseEnabled(x=True, y=True)

            # SensÃ¶rler iÃ§in curves oluÅŸtur - Beyaz, Mavi, KÄ±rmÄ±zÄ±, YeÅŸil
            colors = ['#FFFFFF', '#0066FF', '#FF0000', '#00CC00']  # Beyaz, Mavi, KÄ±rmÄ±zÄ±, YeÅŸil
            for i, sensor_key in enumerate(self.selected_sensors):
                color = colors[i % len(colors)]
                curve = self.plot_widget.plot(
                    [], [],
                    pen=pg.mkPen(color=color, width=3),  # Ã‡izgi kalÄ±nlÄ±ÄŸÄ±nÄ± artÄ±rdÄ±k
                    name=sensor_key
                )
                self.plot_curves[sensor_key] = curve

            # Plot widget'Ä± layout'a ekle
            layout.addWidget(self.plot_widget)

            # Legend ekle
            if self.selected_sensors:
                self.plot_widget.addLegend()

            # Ana widget'Ä± gÃ¶ster
            self.main_widget.show()
            self.main_widget.resize(950, 700)
            
            # Pencere baÅŸlÄ±ÄŸÄ±nÄ± ayarla
            if "Raw Data" in self.title:
                window_title = "Spektroskopi - Raw Data Visualization"
            elif "Calibrated Data" in self.title:
                window_title = "Spektroskopi - Calibrated Data Visualization"
            else:
                window_title = f"Spektroskopi - {self.title}"
            
            self.main_widget.setWindowTitle(window_title)

            print(f"PyQt grafik penceresi oluÅŸturuldu: {self.title}")

        except Exception as e:
            print(f"Grafik penceresi kurulum hatasÄ±: {e}")

    def create_main_title(self, layout):
        """Ana baÅŸlÄ±ÄŸÄ± oluÅŸtur"""
        try:
            # BaÅŸlÄ±k widget'Ä±
            title_widget = QWidget()
            title_layout = QHBoxLayout(title_widget)
            title_layout.setContentsMargins(10, 10, 10, 5)
            
            # BaÅŸlÄ±k metnini belirle
            if "Raw Data" in self.title:
                title_text = "ðŸ“Š Raw Data"
                title_color = "#FF6B6B"  # KÄ±rmÄ±zÄ±
            elif "Calibrated Data" in self.title:
                title_text = "ðŸ“ˆ Calibrated Data"
                title_color = "#4ECDC4"  # Turkuaz
            else:
                title_text = f"ðŸ“Š {self.title}"
                title_color = "#333333"  # Koyu gri
            
            # BaÅŸlÄ±k etiketi
            main_title = QLabel(title_text)
            main_title.setStyleSheet(f"""
                QLabel {{
                    font-size: 18px;
                    font-weight: bold;
                    color: {title_color};
                    padding: 5px 10px;
                    border: 2px solid {title_color};
                    border-radius: 8px;
                    background-color: rgba(255, 255, 255, 0.9);
                }}
            """)
            
            title_layout.addWidget(main_title)
            title_layout.addStretch()  # Sola yasla
            
            # Layout'a ekle
            layout.addWidget(title_widget)
            
        except Exception as e:
            print(f"Ana baÅŸlÄ±k oluÅŸturma hatasÄ±: {e}")

    def create_led_legend(self, layout):
        """LED renk gÃ¶stergesini oluÅŸtur"""
        try:
            # LED renk mapping - Beyaz, Mavi, KÄ±rmÄ±zÄ±, YeÅŸil
            led_info = {
                'UV_360nm': ('UV LED (360nm)', '#FFFFFF'),    # Beyaz
                'Blue_450nm': ('Blue LED (450nm)', '#0066FF'), # Mavi
                'IR_850nm': ('IR LED (850nm)', '#FF0000'),     # KÄ±rmÄ±zÄ±
                'IR_940nm': ('IR LED (940nm)', '#00CC00')      # YeÅŸil
            }

            # Legend container
            legend_widget = QWidget()
            legend_layout = QHBoxLayout(legend_widget)
            legend_layout.setContentsMargins(10, 5, 10, 5)

            # BaÅŸlÄ±k
            title_label = QLabel("LED Color Legend:")
            title_label.setStyleSheet("font-weight: bold; margin-right: 10px;")
            legend_layout.addWidget(title_label)

            # Her LED iÃ§in renk kutusu ve etiket
            for sensor_key in self.selected_sensors:
                if sensor_key in led_info:
                    led_name, color_hex = led_info[sensor_key]

                    # Renk kutusu
                    color_label = QLabel("â–ˆ")
                    if color_hex == '#FFFFFF':  # Beyaz renk iÃ§in border ekle
                        color_label.setStyleSheet(f"color: {color_hex}; font-size: 20px; margin-right: 3px; border: 1px solid #333333;")
                    else:
                        color_label.setStyleSheet(f"color: {color_hex}; font-size: 20px; margin-right: 3px;")
                    legend_layout.addWidget(color_label)

                    # LED adÄ±
                    name_label = QLabel(led_name)
                    name_label.setStyleSheet("margin-right: 15px;")
                    legend_layout.addWidget(name_label)

            # Spacer
            legend_layout.addStretch()

            # Legend'Ä± layout'a ekle
            layout.addWidget(legend_widget)

        except Exception as e:
            print(f"LED legend oluÅŸturma hatasÄ±: {e}")
    
    def setup_update_timer(self):
        """GÃ¼ncelleme timer'Ä±nÄ± kur"""
        try:
            self.update_timer = QTimer()
            self.update_timer.timeout.connect(self.update_data)
            self.update_timer.start(500)  # 500ms'de bir gÃ¼ncelle
            
            print("GÃ¼ncelleme timer'Ä± baÅŸlatÄ±ldÄ±")
            
        except Exception as e:
            print(f"Timer kurulum hatasÄ±: {e}")
    
    def update_data(self):
        """Veri dosyasÄ±ndan gÃ¼ncel verileri yÃ¼kle ve grafiÄŸi gÃ¼ncelle"""
        try:
            if not os.path.exists(self.data_file_path):
                return
            
            with open(self.data_file_path, 'r') as f:
                data = json.load(f)
            
            if 'timestamps' in data and 'data' in data:
                timestamps_iso = data['timestamps']
                sensor_data = data['data']
                
                print(f"Veri gÃ¼ncelleme: {len(timestamps_iso)} zaman noktasÄ±, {len(sensor_data)} sensÃ¶r")
                print(f"Gelen sensÃ¶r anahtarlarÄ±: {list(sensor_data.keys())}")
                print(f"Beklenen sensÃ¶rler: {self.selected_sensors}")
                
                # Zaman verilerini datetime'a Ã§evir
                if timestamps_iso and sensor_data:
                    timestamps = [datetime.fromisoformat(t) for t in timestamps_iso]
                    
                    # Zaman sÄ±ralamasÄ± kontrolÃ¼ - geriye giden zamanlarÄ± dÃ¼zelt
                    sorted_timestamps = []
                    last_time = None
                    
                    for t in timestamps:
                        if last_time is None:
                            sorted_timestamps.append(t)
                            last_time = t
                        elif t >= last_time:
                            sorted_timestamps.append(t)
                            last_time = t
                        else:
                            # Geriye giden zaman - son zamandan 1ms sonra ayarla
                            corrected_time = last_time + timedelta(milliseconds=1)
                            sorted_timestamps.append(corrected_time)
                            last_time = corrected_time
                            print(f"Zaman sÄ±ralama dÃ¼zeltildi: {t} -> {corrected_time}")
                    
                    # Zaman verilerini saniye cinsine Ã§evir
                    if len(sorted_timestamps) > 0:
                        start_time = sorted_timestamps[0]
                        time_seconds = [(t - start_time).total_seconds() for t in sorted_timestamps]
                        
                        # Her sensÃ¶r iÃ§in veriyi gÃ¼ncelle
                        for sensor_key in self.selected_sensors:
                            if sensor_key in sensor_data:
                                if sensor_key in self.plot_curves:
                                    sensor_values = sensor_data[sensor_key]
                                    
                                    # Veri formatÄ±nÄ± kontrol et ve iÅŸle
                                    processed_values = []
                                    for value in sensor_values:
                                        if "Calibrated" in self.title:
                                            # Calibrated data iÃ§in N/A kontrolÃ¼
                                            if value is None or (isinstance(value, (int, float)) and value == 0):
                                                processed_values.append(float('nan'))  # N/A iÃ§in NaN kullan
                                            else:
                                                processed_values.append(float(value))
                                        else:
                                            # Raw data iÃ§in mV formatÄ± (4 haneli)
                                            if isinstance(value, (int, float)):
                                                processed_values.append(max(0, min(9999, int(value))))
                                            else:
                                                processed_values.append(0)
                                    
                                    # Veri uzunluklarÄ±nÄ± eÅŸitle
                                    min_len = min(len(time_seconds), len(processed_values))
                                    if min_len > 0:
                                        self.plot_curves[sensor_key].setData(
                                            time_seconds[:min_len], 
                                            processed_values[:min_len]
                                        )
                                        print(f"SensÃ¶r gÃ¼ncellendi: {sensor_key}, {min_len} nokta")
                                else:
                                    print(f"Plot curve bulunamadÄ±: {sensor_key}")
                            else:
                                print(f"SensÃ¶r verisi bulunamadÄ±: {sensor_key}")
            
        except Exception as e:
            print(f"Veri gÃ¼ncelleme hatasÄ±: {e}")

def main():
    """Ana fonksiyon"""
    if len(sys.argv) != 2:
        print("KullanÄ±m: python3 pyqt_standalone.py <data_file_path>")
        sys.exit(1)
    
    data_file_path = sys.argv[1]
    
    # QApplication oluÅŸtur
    app = QApplication(sys.argv)
    
    # Grafik penceresi oluÅŸtur
    window = StandalonePlotWindow(data_file_path)
    
    # Uygulama dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
    sys.exit(app.exec_())

if __name__ == "__main__":
    main()
